{extend name="public/base" /}
{block name="user_css"}
{/block}
{block name="content_main"}
<section class="content"  style="width: 90%;margin-left: 2%;">
    <form id="article_form" role="form">
        <div class="input-group mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text">标题</span>
            </div>
            <input type="text" class="form-control" id="title" name="title" placeholder="请输入文章标题" value="{$article.title}">
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">发布单位</span>
                    </div>
                    <input type="text" class="form-control" id="level1" name="level1" placeholder="请输入发布单位全称" value="{$article.level1}">
                </div>
            </div>
            <div class="col-lg-6">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">文章分类</span>
                    </div>
                    <input type="text" class="form-control" id="level2" name="level2" placeholder="请输入文章所属类别" value="{$article.level2}">
                </div>
            </div>
        </div>
        <!-- CkKeditor -->

        <div class="document-editor">
            <div id="toolbar-container"></div>
            <div id="ckeditor">
                <div>
                    {$article.content}
                </div>
            </div>
        </div>
    </form>
    <br/>
    <button name="submit" class="btn btn-primary" onclick="addNewArticle()">发布</button>
    <button name="cancel" class="btn btn-danger" onclick="#">取消</button>
</section>
{/block}
{block name="user_js"}
<script>
    var ckeditor;
    const web_head = '<meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />';

    document.addEventListener("DOMContentLoaded", function(event){
        console.log("DOM fully loaded and parsed");
        DecoupledEditor
            .create(document.querySelector('#ckeditor'), {
                ckfinder: {
                    uploadUrl: 'http://localhost/uploadImage'
                }
            })
            .then(
                editor_ => {const toolbarContainer = document.querySelector( '#toolbar-container' );
                toolbarContainer.appendChild( editor_.ui.view.toolbar.element );
                ckeditor = editor_;})
            .catch(
                error => {console.error( error );}
        );
    })

    // 添加新文章
    function addNewArticle() {
        console.log('add new article', true);
        var null_msg = '';
        var d = {};
        var t = $('#article_form').serializeArray();
        var data = '';
        const ckeditor_data = ckeditor.getData();
        if (ckeditor_data.length>2){
            data = web_head + ckeditor_data;
        }
        $.each(t, function () {
            if(this.value.length>1){
                d[this.name] = this.value;
            } else {
                null_msg += this.name + '不能为空;';
            }
        });
        if(data.length>1){
            d['content'] = data;
        } else {
            null_msg += 'ckdata不能为空;'
        }
        if (null_msg.length>=4){
            swal('Oops!', null_msg, 'warning');
        } else {
            var update = formDate();
            d['time'] = update;
            console.log(new Array(d));
            $.ajax({
                type: 'post',
                url: '/insertArticle',
                data: {'data':new Array(d)},
                dataType: 'json',
                success: function (res) {
                    console.log('后台返回数据',res)
                    if(res.flag === 'S'){
                        swal('恭喜！', res.msg, 'success', 'OK');
                    } else {
                        swal('Oops!', res.mag, 'info');
                    }
                },
                error: function (err, zt, yy) {
                    swal('发生错误', JSON.stringify(err), 'error');
                }
            });
        }
    }

    // 格式化当前时间
    function formDate() {
        var date = new Date();
        var yy = date.getFullYear() + '-';
        var MM = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
        var dd = date.getDate()<10? ('0'+(date.getDate())+' '):(date.getDate() + ' ');
        var HH = date.getHours() + ':';
        var mm = date.getMinutes() + ':';
        var ss = date.getSeconds();
        return yy+MM+dd+HH+mm+ss;
    }
</script>
{/block}